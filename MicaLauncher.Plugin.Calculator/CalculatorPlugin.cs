using System.Windows.Media;
using System.Windows.Threading;
using MicaLauncher.Data;
using MicaLauncher.Utilities;
using NCalculatorLib;

namespace MicaLauncher.Plugin.Calculator
{

    public class CalculatorPlugin : ISyncPlugin
    {
        public static string IconSvg { get; } = "<svg t=\"1695796136089\" class=\"icon\" viewBox=\"0 0 1024 1024\" version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" p-id=\"1172\" width=\"200\" height=\"200\"><path d=\"M47.5904 168.2176h-0.98304v248.09472h930.48832V355.77856c0.04096-0.9984 0.29696-1.94048 0.29696-2.94912V177.9968c0-1.00864-0.256-1.95072-0.29696-2.94912v-6.8352h-0.6912c-4.7872-33.40288-33.23392-59.16672-67.96288-59.16672H115.55328c-34.72384 0.00512-63.17056 25.76896-67.96288 59.17184z\" fill=\"#414040\" p-id=\"1173\"></path><path d=\"M976.4096 855.7824h0.98816V405.23264H46.90432V465.7664c-0.04096 0.9984-0.29696 1.94048-0.29696 2.94912v377.28256c0 1.00864 0.256 1.95072 0.29696 2.94912v6.8352h0.6912c4.7872 33.40288 33.23392 59.16672 67.96288 59.16672h792.89344c34.71872 0 63.16544-25.76384 67.95776-59.16672z\" fill=\"#E6E4E2\" p-id=\"1174\"></path><path d=\"M165.248 189.33248h693.504v126.09024H165.248z\" fill=\"#FFFFFF\" p-id=\"1175\"></path><path d=\"M269.8496 502.87616v-28.38016c0-0.16384-0.04096-0.31744-0.04608-0.47616v-1.11104h-0.11264a11.1616 11.1616 0 0 0-11.0336-9.60512H129.95584a11.1616 11.1616 0 0 0-11.0336 9.60512h-0.15872v40.27392h0.04608v8.02816c-0.00512 0.16384-0.04608 0.31232-0.04608 0.47616v23.58784c0 0.16384 0.04096 0.31744 0.04608 0.47616v1.11104h0.11264a11.1616 11.1616 0 0 0 11.0336 9.60512H258.6624a11.1616 11.1616 0 0 0 11.0336-9.60512h0.15872V511.3856h-0.04608v-8.02816c0-0.16384 0.04096-0.31744 0.04096-0.48128zM269.8496 647.75168v-28.38016c0-0.16384-0.04096-0.31744-0.04608-0.47616v-1.11104h-0.11264a11.1616 11.1616 0 0 0-11.0336-9.60512H129.95584a11.1616 11.1616 0 0 0-11.0336 9.60512h-0.15872v40.27392h0.04608v8.02816c-0.00512 0.16384-0.04608 0.31232-0.04608 0.47616v23.58784c0 0.16384 0.04096 0.31744 0.04608 0.47616v1.11104h0.11264a11.1616 11.1616 0 0 0 11.0336 9.60512H258.6624a11.1616 11.1616 0 0 0 11.0336-9.60512h0.15872v-35.4816h-0.04608v-8.02816c0-0.15872 0.04096-0.31232 0.04096-0.47616zM269.8496 792.6272v-28.38016c0-0.16384-0.04096-0.31744-0.04608-0.47616v-1.11104h-0.11264a11.1616 11.1616 0 0 0-11.0336-9.60512H129.95584a11.1616 11.1616 0 0 0-11.0336 9.60512h-0.15872v40.27392h0.04608v8.02816c-0.00512 0.16384-0.04608 0.31232-0.04608 0.47616v23.58784c0 0.16384 0.04096 0.31744 0.04608 0.47616v1.11104h0.11264a11.1616 11.1616 0 0 0 11.0336 9.60512H258.6624a11.1616 11.1616 0 0 0 11.0336-9.60512h0.15872v-35.4816h-0.04608v-8.02816c0-0.15872 0.04096-0.31232 0.04096-0.47616zM484.20352 502.87616v-28.38016c0-0.16384-0.04096-0.31744-0.04608-0.47616v-1.11104h-0.11264a11.1616 11.1616 0 0 0-11.0336-9.60512H344.30976a11.1616 11.1616 0 0 0-11.0336 9.60512h-0.15872v40.27392h0.04608v8.02816c-0.00512 0.16384-0.04608 0.31232-0.04608 0.47616v23.58784c0 0.16384 0.04096 0.31744 0.04608 0.47616v1.11104h0.11264a11.1616 11.1616 0 0 0 11.0336 9.60512h128.70656a11.1616 11.1616 0 0 0 11.0336-9.60512h0.15872V511.3856h-0.04608v-8.02816c0-0.16384 0.04096-0.31744 0.04096-0.48128zM484.20352 647.75168v-28.38016c0-0.16384-0.04096-0.31744-0.04608-0.47616v-1.11104h-0.11264a11.1616 11.1616 0 0 0-11.0336-9.60512H344.30976a11.1616 11.1616 0 0 0-11.0336 9.60512h-0.15872v40.27392h0.04608v8.02816c-0.00512 0.16384-0.04608 0.31232-0.04608 0.47616v23.58784c0 0.16384 0.04096 0.31744 0.04608 0.47616v1.11104h0.11264a11.1616 11.1616 0 0 0 11.0336 9.60512h128.70656a11.1616 11.1616 0 0 0 11.0336-9.60512h0.15872v-35.4816h-0.04608v-8.02816c0-0.15872 0.04096-0.31232 0.04096-0.47616zM484.20352 792.6272v-28.38016c0-0.16384-0.04096-0.31744-0.04608-0.47616v-1.11104h-0.11264a11.1616 11.1616 0 0 0-11.0336-9.60512H344.30976a11.1616 11.1616 0 0 0-11.0336 9.60512h-0.15872v40.27392h0.04608v8.02816c-0.00512 0.16384-0.04608 0.31232-0.04608 0.47616v23.58784c0 0.16384 0.04096 0.31744 0.04608 0.47616v1.11104h0.11264a11.1616 11.1616 0 0 0 11.0336 9.60512h128.70656a11.1616 11.1616 0 0 0 11.0336-9.60512h0.15872v-35.4816h-0.04608v-8.02816c0-0.15872 0.04096-0.31232 0.04096-0.47616zM698.55744 502.87616v-28.38016c0-0.16384-0.04096-0.31744-0.04608-0.47616v-1.11104h-0.11264a11.1616 11.1616 0 0 0-11.0336-9.60512h-128.70656a11.1616 11.1616 0 0 0-11.0336 9.60512h-0.15872v40.27392h0.04608v8.02816c-0.00512 0.16384-0.04608 0.31232-0.04608 0.47616v23.58784c0 0.16384 0.04096 0.31744 0.04608 0.47616v1.11104h0.11264a11.1616 11.1616 0 0 0 11.0336 9.60512h128.70656a11.1616 11.1616 0 0 0 11.0336-9.60512h0.15872V511.3856h-0.04608v-8.02816c0.00512-0.16384 0.04608-0.31744 0.04608-0.48128z\" fill=\"#807E7E\" p-id=\"1176\"></path><path d=\"M911.65696 502.87616v-28.38016c0-0.16384-0.04096-0.31744-0.04608-0.47616v-1.11104h-0.11264a11.1616 11.1616 0 0 0-11.0336-9.60512h-128.70656a11.1616 11.1616 0 0 0-11.0336 9.60512h-0.15872v40.27392h0.04608v8.02816c-0.00512 0.16384-0.04608 0.31232-0.04608 0.47616v23.58784c0 0.16384 0.04096 0.31744 0.04608 0.47616v1.11104h0.11264a11.1616 11.1616 0 0 0 11.0336 9.60512h128.70656a11.1616 11.1616 0 0 0 11.0336-9.60512h0.15872V511.3856h-0.04608v-8.02816c0.00512-0.16384 0.04608-0.31744 0.04608-0.48128z\" fill=\"#F38181\" p-id=\"1177\"></path><path d=\"M915.86048 787.7376v-166.76352c0-0.16384-0.04096-0.31744-0.04608-0.47616v-1.11104h-0.11264a11.1616 11.1616 0 0 0-11.0336-9.60512h-128.70656a11.1616 11.1616 0 0 0-11.0336 9.60512h-0.15872v178.65728h0.04608v8.02816c-0.00512 0.16384-0.04608 0.31232-0.04608 0.47616v23.58784c0 0.16384 0.04096 0.31744 0.04608 0.47616v1.11104h0.11264a11.1616 11.1616 0 0 0 11.0336 9.60512h128.70656a11.1616 11.1616 0 0 0 11.0336-9.60512h0.15872v-35.4816h-0.04608v-8.02816c0.00512-0.15872 0.04608-0.31232 0.04608-0.47616z\" fill=\"#5B5144\" p-id=\"1178\"></path><path d=\"M698.55744 647.75168v-28.38016c0-0.16384-0.04096-0.31744-0.04608-0.47616v-1.11104h-0.11264a11.1616 11.1616 0 0 0-11.0336-9.60512h-128.70656a11.1616 11.1616 0 0 0-11.0336 9.60512h-0.15872v40.27392h0.04608v8.02816c-0.00512 0.16384-0.04608 0.31232-0.04608 0.47616v23.58784c0 0.16384 0.04096 0.31744 0.04608 0.47616v1.11104h0.11264a11.1616 11.1616 0 0 0 11.0336 9.60512h128.70656a11.1616 11.1616 0 0 0 11.0336-9.60512h0.15872v-35.4816h-0.04608v-8.02816c0.00512-0.15872 0.04608-0.31232 0.04608-0.47616zM698.55744 792.6272v-28.38016c0-0.16384-0.04096-0.31744-0.04608-0.47616v-1.11104h-0.11264a11.1616 11.1616 0 0 0-11.0336-9.60512h-128.70656a11.1616 11.1616 0 0 0-11.0336 9.60512h-0.15872v40.27392h0.04608v8.02816c-0.00512 0.16384-0.04608 0.31232-0.04608 0.47616v23.58784c0 0.16384 0.04096 0.31744 0.04608 0.47616v1.11104h0.11264a11.1616 11.1616 0 0 0 11.0336 9.60512h128.70656a11.1616 11.1616 0 0 0 11.0336-9.60512h0.15872v-35.4816h-0.04608v-8.02816c0.00512-0.15872 0.04608-0.31232 0.04608-0.47616z\" fill=\"#807E7E\" p-id=\"1179\"></path></svg>";

        [PluginOption]
        public string Prefix { get; set; } = "=";

        public ImageSource Icon => ImageUtils.CreateFromSvg(IconSvg);

        public string Name => "Calculator";

        public string Description => "Math calculation";

        public void Init()
        {
            // do nothing
        }

        public IEnumerable<QueryResult> Query(MicaLauncherContext context, string query)
        {
            if (!query.StartsWith(Prefix))
                yield break;

            string expr = query.Substring(Prefix.Length);
            double result;

            try
            {
                result = NCalc.Eval(expr);
            }
            catch
            {
                yield break;
            }

            yield return new CalculatorQueryResult(result);
        }
    }
}